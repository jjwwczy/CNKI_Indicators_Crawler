# CNKI 指标数据爬虫使用指南

## 简介

本程序是一个用于从 **中国知网（CNKI）** 的[经济社会大数据研究平台](https://data.cnki.net/trade/home?zcode=Z017)自动抓取指标数据的爬虫工具。它可以根据预设的查询任务，批量抓取数据并将其保存到本地数据库中，极大提高了数据采集的效率。

## 功能特性

- **批量处理**: 可通过 `tasks.xlsx` 文件配置多个抓取任务，程序会自动依次执行。
- **灵活排序**: 支持按“相关度”或默认的“年鉴年份”进行排序。
- **链接抓取**: 可选择是否抓取每条数据的 Excel 下载链接（注意：此功能会显著降低抓取速度）。
- **自动翻页**: 可设定最大抓取页数，程序会自动处理翻页操作。
- **数据存储**: 抓取结果会自动保存到 `crawler_results.db` 数据库文件中，方便后续使用。
- **断点续传**: 如果某个任务失败，程序会自动跳过并继续执行下一个任务。

---

## 环境配置

在第一次使用前，请按照以下步骤配置好运行环境。**（只需配置一次）**

### 第一步：安装 Python

如果你的电脑还没有安装 Python，请从 [Python 官网](https://www.python.org/downloads/) 下载并安装最新版本的 Python。在安装时，请务必勾选 **“Add Python to PATH”** 选项。

### 第二步：安装程序依赖

1.  打开一个终端（在 Windows 上，可以搜索 “cmd” 或 “PowerShell” 并打开）。
2.  使用 `cd` 命令进入到本程序所在的文件夹。例如：
    ```bash
    cd D:\路径\到\CNKI_Crawler
    ```
3.  运行以下命令来安装所有必需的第三方库：
    ```bash
    pip install -r requirements.txt
    ```
    如果你在中国大陆，可能需要先更换pip的镜像源：
    ```bash
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
    ```
    然后再安装库会快很多
    ```bash
    pip install -r requirements.txt
    ```

### 第三步：安装浏览器驱动

本程序需要一个浏览器核心来模拟真人操作。运行以下命令来自动安装：

```bash
playwright install
```

如果因为网络问题下载缓慢，可以尝试配置国内镜像源（可选）：

```bash
set PLAYWRIGHT_DOWNLOAD_HOST=https://playwright.azureedge.net
playwright install
```

当终端显示安装成功后，环境就配置好了。

---

## 如何使用

### 1. 配置抓取任务 (`tasks.xlsx`)

所有要抓取的任务都在 `tasks.xlsx` 文件中进行配置。打开这个 Excel 文件，每一行代表一个独立的抓取任务。

请根据需要填写以下列：

| 列名 | 含义 | 示例 | 备注 |
| :--- | :--- | :--- | :--- |
| `zcode` | 指标代码 | `Z017` | 从 Zcode 附表中选择，这里是“中国教育与经济社会发展统计数据库”在知网网站中的代码。 |
| `indicateName` | 指标名称 | `化肥施用量` | 你想要查询的具体指标。 |
| `searchModeOne` | 搜索模式 | `0` | 0表示模糊，1表示精确，一般保持 `0` 即可。 |
| `area` | 地区 | `土默特右旗` | 你想查询的地区名称。 |
| `beginYear` | 开始年份 | `2005` | 四位数的年份。 |
| `endYear` | 结束年份 | `2010` | 四位数的年份。 |
| `dataType` | 数据类型 | `year` | 可选值为 `year` (年度), `jindu` (进度), `world` (国际)。 |
| `sort` | 排序方式 | `相关度` | **留空**则按默认的年份排序；填写 **`相关度`** 则按相关度排序。 |

## Z-Code 附表

下表列出了部分 `zcode` 及其对应的数据库名称：

| zcode | 数据库名称 |
| :--- | :--- |
| 001 | 中国劳动就业与经济社会发展统计数据库 |
| 003 | 中国财税与经济社会发展统计数据库 |
| 004 | 中国商贸外经与经济社会发展统计数据库 |
| 005 | 国城建(建筑业)与经济社会发展统计数据库 |
| 006 | 中国国土资源与经济社会发展统计数据库 |
| 007 | 中国海洋与经济社会发展统计数据库 |
| 008 | 中国环境保护与经济社会发展统计数据库 |
| 009 | 中国农业与经济社会发展统计数据库 |
| 010 | 中国林业与经济社会发展统计数据库 |
| 011 | 中国水利与经济社会发展统计数据库 |
| 012 | 中国工业经济与经济社会发展统计数据库 |
| 013 | 中国房地产与经济社会发展统计数据库 |
| 014 | 中国交通行业与经济社会发展统计数据库 |
| 015 | 中国旅游与经济社会发展统计数据库 |
| 016 | 中国金融与经济社会发展统计数据库 |
| 017 | 中国教育与经济社会发展统计数据库 |
| 018 | 中国科技与经济社会发展统计数据库 |
| 019 | 中国文化与经济社会发展统计数据库 |
| 020 | 中国卫生与经济社会发展统计数据库 |
| 021 | 中国民政与经济社会发展统计数据库 |
| 022 | 中国公检法司与经济社会发展统计数据库 |
| 023 | 中国石油石化产业与经济社会发展统计数据库 |
| 024 | 中国煤炭产业与经济社会发展统计数据库 |
| 025 | 中国电力行业与经济社会发展统计数据库 |
| 026 | 中国钢铁产业与经济社会发展统计数据库 |
| 027 | 中国有色金属产业与经济社会发展统计数据库 |
| 028 | 中国汽车产业与经济社会发展统计数据库 |
| 029 | 中国船舶产业与经济社会发展统计数据库 |
| 030 | 中国民用航空工业与经济社会发展统计数据屋 |
| 031 | 中国电子信息产业与经济社会发展统计数据库 |
| 032 | 中国机械工业与经济社会发展统计数据库 |
| 033 | 中国轻工业与经济社会发展统计数据库 |

你可以根据需要添加任意多行任务。

### 2. 配置主程序 (`main(单线程).py`)

打开 `main(单线程).py` 文件，在 `main` 函数顶部你可以找到几个全局控制参数：

- **`maxpages`**: 每个任务最多抓取的页数。例如，设置为 `5`，则每个任务最多翻 5 页。
- **`GET_DOWNLOAD_LINKS`**: 是否要抓取 Excel 下载链接。
  - `True`: 抓取链接（速度慢）。
  - `False`: 不抓取链接（速度快）。
- **`CLEAR_DATABASE_BEFORE_CRAWL`**: 每次运行前是否清空数据库。
  - `True`: 清空数据库，适合全新抓取。
  - `False`: 不清空数据库，在原有数据基础上进行补充。

### 3. 运行程序

---

1.  打开终端（cmd 或 PowerShell）。
2.  `cd` 到程序所在的文件夹。
3.  运行以下命令启动爬虫：
    ```bash
    python "main(单线程).py"
    ```
4.  程序会弹出一个浏览器窗口并开始自动执行任务。你可以观察终端的输出来了解抓取进度。

---

## 输出结果

所有成功抓取的数据都会被保存在 `crawler_results.db` 文件中。这是一个 SQLite 数据库文件，你可以使用任何支持 SQLite 的工具（我使用的是navicat premium lite）来打开、查看和导出数据。

## 常见问题

- **程序报错或卡住怎么办？**
  - 可能是网络波动或网站的反爬虫机制。可以尝试关闭程序和弹出的浏览器窗口，稍等片刻后重新运行。
- **如何导出数据为 Excel？**
  - 使用任何 SQLite 数据库管理工具（如 DB Browser for SQLite）打开 `crawler_results.db` 文件，找到 `cnki_indicators` 表，通常都会有导出为 CSV 或 Excel 的功能。
- **抓取速度很慢怎么办？**
  - 确认 `main(单线程).py` 文件中的 `GET_DOWNLOAD_LINKS` 参数是否设置为了 `False`。抓取下载链接需要模拟点击和拦截，会大大增加耗时。
